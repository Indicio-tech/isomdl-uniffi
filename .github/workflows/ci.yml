name: CI

on:
  pull_request:
    branches: [ main, develop ]
  push:
    branches: [ main, develop ]

env:
  CARGO_TERM_COLOR: always

jobs:
  lint-checks:
    name: Lint and Format Checks
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Install Rust toolchain
        uses: dtolnay/rust-toolchain@stable
        with:
          components: rustfmt, clippy

      - name: Set up Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.11'

      - name: Install Python linting tools
        run: |
          pip install black flake8

      - name: Check Rust formatting
        run: |
          cd rust
          cargo fmt -- --check

      - name: Check Python formatting
        run: |
          black --check python/tests/

      - name: Run Python linting
        run: |
          flake8 python/tests/ --max-line-length=100 --ignore=E203,W503,F821

      - name: Run Clippy (without building)
        run: |
          cd rust
          cargo clippy -- -D warnings

  rust-build-and-test:
    name: Rust Build and Test
    runs-on: ubuntu-latest
    needs: lint-checks
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Install Rust toolchain
        uses: dtolnay/rust-toolchain@stable

      - name: Cache Rust dependencies
        uses: actions/cache@v3
        with:
          path: |
            ~/.cargo/registry
            ~/.cargo/git
            rust/target
          key: ${{ runner.os }}-cargo-${{ hashFiles('**/Cargo.lock') }}
          restore-keys: |
            ${{ runner.os }}-cargo-

      - name: Build Rust crate
        run: |
          cd rust
          cargo build --release

      - name: Run Rust tests
        run: |
          cd rust
          cargo test

  build-bindings:
    name: Build Python Bindings
    runs-on: ${{ matrix.os }}
    needs: [lint-checks, rust-build-and-test]
    # Build bindings once per platform, then test against multiple Python versions
    strategy:
      matrix:
        os: [ubuntu-latest, macos-latest]
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Install Rust toolchain
        uses: dtolnay/rust-toolchain@stable

      - name: Set up Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.11'  # Use one Python version for building

      - name: Install uv
        uses: astral-sh/setup-uv@v3
        with:
          enable-cache: false

      - name: Cache Rust dependencies
        uses: actions/cache@v3
        with:
          path: |
            ~/.cargo/registry
            ~/.cargo/git
            rust/target
          key: ${{ runner.os }}-cargo-${{ hashFiles('**/Cargo.lock') }}
          restore-keys: |
            ${{ runner.os }}-cargo-

      - name: Build Python bindings
        run: |
          chmod +x python/precommit/build-bindings.sh
          echo "ðŸ” Current working directory: $(pwd)"
          echo "ðŸ” Python version: $(python3 --version)"
          echo "ðŸ” Rust version: $(rustc --version)"
          ./python/precommit/build-bindings.sh

      - name: Debug built artifacts
        run: |
          echo "ðŸ” Checking built artifacts before upload..."
          ls -la rust/out/python/ || echo "Directory not found!"
          find rust/out/python/ -type f || echo "No files found"
          echo "ðŸ” File details:"
          file rust/out/python/* 2>/dev/null || echo "No files to analyze"

      - name: Upload bindings artifact
        uses: actions/upload-artifact@v4
        with:
          name: python-bindings-${{ matrix.os }}
          path: rust/out/python/
          retention-days: 1

  test-python:
    name: Test Python ${{ matrix.python-version }} on ${{ matrix.os }}
    runs-on: ${{ matrix.os }}
    needs: build-bindings
    # Test the pre-built bindings against multiple Python versions
    strategy:
      matrix:
        os: [ubuntu-latest, macos-latest]
        python-version: ['3.9', '3.10', '3.11', '3.12']
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Python ${{ matrix.python-version }}
        uses: actions/setup-python@v4
        with:
          python-version: ${{ matrix.python-version }}

      - name: Install uv
        uses: astral-sh/setup-uv@v3
        with:
          enable-cache: false

      - name: Download bindings artifact  
        uses: actions/download-artifact@v4
        with:
          name: python-bindings-${{ matrix.os }}
          path: rust/out/python/

      - name: Debug downloaded artifacts
        run: |
          echo "ðŸ” Checking downloaded artifacts..."
          ls -la rust/out/python/ || echo "Directory not found!"
          find . -name "*.so" -o -name "*.dylib" -o -name "*.dll" || echo "No shared libraries found"
          # Ensure shared libraries are executable
          find rust/out/python/ -name "*.so" -o -name "*.dylib" -o -name "*.dll" | xargs chmod +x 2>/dev/null || true

      - name: Install Python dependencies
        run: |
          cd python
          uv pip install --system pytest

      - name: Run Python tests
        run: |
          chmod +x python/precommit/run-tests.sh
          echo "ðŸ” Current working directory: $(pwd)"
          echo "ðŸ” Contents of rust/out/python before test:"
          ls -la rust/out/python/ || echo "Directory not found!"
          ./python/precommit/run-tests.sh

  integration-tests:
    name: Integration Tests
    runs-on: ubuntu-latest
    needs: [rust-build-and-test, build-bindings, test-python]
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.11'

      - name: Download pre-built bindings
        uses: actions/download-artifact@v4
        with:
          name: python-bindings-ubuntu-latest
          path: rust/out/python/

      - name: Debug downloaded bindings
        run: |
          echo "ðŸ” Checking downloaded bindings..."
          ls -la rust/out/python/ || echo "Directory not found!"
          find rust/out/python/ -name "*.so" -o -name "*.py" || echo "No binding files found"
          # Ensure shared libraries are executable
          find rust/out/python/ -name "*.so" | xargs chmod +x 2>/dev/null || true

      - name: Run comprehensive Python test suite
        run: |
          # Run comprehensive Python test suite using pre-built bindings
          chmod +x python/precommit/run-tests.sh
          ./python/precommit/run-tests.sh

      - name: Verify selective disclosure tests
        run: |
          cd python/tests
          python3 -c "
          import sys, os
          sys.path.insert(0, '../../rust/out/python')
          import isomdl_uniffi as mdl
          sys.path.insert(0, '.')
          import test_selective_disclosure
          result = test_selective_disclosure.run_tests(mdl)
          assert result == True, 'Selective disclosure tests failed'
          print('âœ… Selective disclosure tests verified')
          "

  security-audit:
    name: Security Audit
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Install Rust toolchain
        uses: dtolnay/rust-toolchain@stable

      - name: Install cargo-audit (with caching)
        uses: taiki-e/install-action@v2
        with:
          tool: cargo-audit

      - name: Run security audit
        run: |
          cd rust
          cargo audit \
            --ignore RUSTSEC-2022-0040 \
            --ignore RUSTSEC-2023-0071 \
            --ignore RUSTSEC-2024-0436 \
            --ignore RUSTSEC-2024-0370

